<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>excel</title>
<link rel="stylesheet" href="lib/bootstrap-4.6.1/css/bootstrap.min.css">
<link rel="stylesheet" href="lib/customFormBasedOnBootstrap4/input-material.css">
<link rel="stylesheet" href="css/animation.css">
<link rel="stylesheet" href="lib/font-awesome/css/font-awesome.css">
<style type="text/css">
#uploadDiv {
	width: 60%;
	height: 400px;
	/* background-color: rgba(250,250,250,0.7); */
	border-radius: 20px;
	border: 5px dashed #fff;
	margin: 0px auto;
	margin-bottom: 10px;
	padding-top: 100px;
	font-size: 20px;
}

#uploadDiv>p {
	text-align: center;
}

#uploadDiv:hover {
	cursor: pointer;
	color: #007bff;
	border: 5px dashed #007bff;
}

.form-group.input-material .form-control:focus, .form-group.input-material .form-control[value]:not([value=""]){
	border-bottom-color: #ffffff;
	color: #007bff;
	font-size: 30px;
}
.form-group.input-material .form-control:focus ~ label, .form-group.input-material .form-control[value]:not([value=""]) ~ label{
	color: #FFFFFF;
}

#logDisplay p{
	margin-bottom: 0px;
    padding-bottom: 0px;
    line-height: 12px;
    padding: 3px 10px;
    color: rgba(255,255,255,0.4);
}
#logDisplay p>span{
	color: #007bff;
}

#logDisplay::-webkit-scrollbar { width: 0 !important }
</style>
</head>
<body>
	<ul id="transBackground">
		<li><span></span></li>
		<li><span></span></li>
		<li><span></span></li>
	</ul>
	<div class="container"
		style="color: #fff; background-color: rgba(0, 0, 0, 0.5);">
		<h2	style="text-align: center; margin-bottom: 10px; padding-top: 70px; color: #fff;">excel分页工具4.2</h2>
		

		<form class="form-horizontal" name="excelForm" id="excelForm">
			
			<div class="row">
				<div class="col-md-3" >
					<div class="form-group input-material">
						<select class="form-control" id="examType" style="border-bottom: 2px solid #ffffff;font-size:30px;color: #007bff;">
							<option value=""></option>
							<option value="xysp">学业水平</option>
							<option value="zk">自学考试</option>
							<option value="zz">中职技能</option>
							<option value="jszg">教师资格</option>
							<option value="wnygz">五年一贯制</option>
							<option value="zsb">专升本</option>
							<option value="gatlz">港澳台联合招生</option>
					  	</select>
				    	<input type="hidden" class="form-control" id="examTypeInput" required>
				    	<label for="name-field">考试类型：</label>
					</div>
				</div>
				<div class="col-md-3" >
					<div class="form-group input-material">
						<select class="form-control" id="excelVersion" style="border-bottom: 2px solid #ffffff;font-size:30px;color: #007bff;">
							<option value=""></option>
							<option value="wps">wps</option>
							<option value="excel">excel</option>
					  	</select>
				    	<input type="hidden" class="form-control" id="excelVersionInput" required>
				    	<label for="name-field">excel版本：</label>
					</div>
				</div>
				
				<div class="col-md-3" >
					<div class="form-group input-material">
					      <input type="text" class="form-control" id="pageSize" value="51">
					      <label for="name-field">每页的行数：</label>
					</div>
				</div>
				
				<div class="col-md-3" >
					<div class="form-group input-material">
						<select class="form-control" id="encodeType" style="border-bottom: 2px solid #ffffff;font-size:30px;color: #007bff;">
							<option value="default">默认</option>
							<option value="a">iso-8859-1 to GBK</option>
					  	</select>
				    	<input type="hidden" class="form-control" id="encodeTypeInput" value="default" required>
				    	<label for="name-field">编码转换：</label>
					</div>
				</div>
			</div>
			
			<div id="uploadDiv" style="position: relative">
				<div id="logDisplay" style="position: absolute;left: 0px;top: 0px;font-size: 12px;width: 100%;height: 100%;overflow: auto;">
					<!-- <p>日志日志</p>
				<p>日志日志</p>
				<p>日志日志</p>
				<p>日志日志</p>
				<p>日志日志</p>
				<p>日志日志</p> -->
				</div>
				<p id="uploadIcon" style="font-size: 80px;"><i class="fa fa-cloud-upload"></i></p>
				<p>点击上传</p>
				<p>或直接将excel文件拖入此区域</p>
				<p>（注：开始处理前需要对dbf相关字段进行排序）</p>
			</div>
<!-- 
			<div style="width: 70%; height: 20px; margin: 0px auto; margin-bottom: 10px;">
				<a href="javascript:void(0);" id="customBtn"style="color: #fff; float: right; padding-right: 20px;">高级选项</a>
			</div>
			 -->
			

		</form>


		<footer style="color: #fff;">
			<hr style="border-top: 2px solid #fff;">
			<!-- Purchase a site license to remove this link from the footer: http://www.portnine.com/bootstrap-themes -->
			<p class="pull-right">服务中心-网络信息部</p>
			<p>© 2021 xiaojz</p>
		</footer>
	</div>

	<script src="js/jquery.min.js"></script>
    <script src="lib/bootstrap-4.6.1/js/bootstrap.bundle.min.js"></script>
    <script src="lib/customFormBasedOnBootstrap4/materialize-inputs.jquery.js"></script>
	<script src="js/layer/layer.js"></script>
	<script src="js/xiaojzUpload.js"></script>
	<script src="js/xiaojzAnimation.js"></script>
	<script type="text/javascript">
		//禁止浏览器打开文件行为	
		document.addEventListener("drop",function(e){e.preventDefault();});
		document.addEventListener("dragleave",function(e){e.preventDefault();});
		document.addEventListener("dragenter",function(e){e.preventDefault();});
		document.addEventListener("dragover",function(e){e.preventDefault();});
	
		var applicationPath = "/BarcodeHandle";
	
		$(function(){
			$('body').materializeInputs();
			//$('form').materializeInputs(".input-material");
			$(".customPara").hide();
			console.info("萧家洲联系电话：13660004900");
			
		});
		
		$("#customBtn").click(function(){
			$(".customPara").show();

			var widthStr = $("#uploadDiv").css("width");
			var widthVal = Number(widthStr.match(/\d+/)[0]);//元素原值
			widthVal *= 1.2;
			
			xiaojzAni.startElasticAni("#uploadDiv","height",200,10);
			xiaojzAni.startElasticAni("#uploadDiv","width",widthVal,10);
			xiaojzAni.startSlowAni("#uploadDiv","font-size",15,10);
			xiaojzAni.startSlowAni("#uploadIcon","font-size",40,10);
			xiaojzAni.startSlowAni("#uploadDiv","padding-top",20,10);
			$(this).hide();
		});
	
		$("#examType").change(function(){
			$("#examTypeInput").val($("#examType").val());//特殊样式，由于原生样式不支持直接展示，只能这样子填充文本值
			if($("#examType").val() == "xysp"){ 
				console.info("学业水平：");
				console.info("select ds_h,dsmc,xq_h,xqmc,kd_h,kdmc,kc_h,kmdm,kmmc,txsj,ksh,zwxh,xm,dtks from XX order by ds_h,xq_h,kd_h,kmdm,kc_h,zwxh");
			}else if($("#examType").val() == "zk"){
				console.info("自学考试：");
				console.info("select 考点代码,考点名称,节点单元,round(考场代码,0),round(科目代码,0),round(座位号,0),姓名 from  ( select 考点代码,考点名称,节点单元,val(考场代码) 考场代码, val(科目代码) 科目代码,val(座位号) 座位号,姓名 from A ) t  ORDER BY 考点代码,节点单元,考场代码,科目代码,座位号");
			}else if($("#examType").val() == "zz"){
				console.info("中职技能：");
				console.info("select xh,ds_h,dsmc,xq_h,xqmc,kddm,kdmc,kmdm,kmmc,dtkys,tmsj,ksh,xm,kcdm,zw from A order by xh");
			}else if($("#examType").val() == "jszg"){
				console.info("教师资格：");
				console.info("select sfdm,kqdm,kddm,kdmc,kmdm,kmmc,kcdm,kczwh,zkzh,ksxm from jszg order by sfdm,kqdm,kddm,kmdm,kcdm,kczwh");
			}else if($("#examType").val() == "wnygz"){
				console.info("五年一贯制：");
				console.info("select kddm,kdmc,kmdm,kmmc,kcdm,zwh,xm from A order by kddm,kmdm,kcdm,zwh");
			}else if($("#examType").val() == "zsb"){
				console.info("专升本：");
				console.info("select kd_h,kdmc,km_h,科目名称,kc_h,zw_h,姓名 from A order by kd_h,km_h,kc_h,zw_h");
			}else if($("#examType").val() == "gatlz"){
				console.info("港澳台联合招生：");
				console.info("select 考点号,考点名称,科目号,科目名称,考场号,座位号,姓名 from lz order by 考点号,科目号,考场号,座位号");
			}
			layer.msg("请打开控制台复制sql语句");
		});
		
		
		$("#excelVersion").change(function(){
			if($("#excelVersion").val() != "" ){
				updateLineNum();
			}
			
			$("#excelVersionInput").val($("#excelVersion").val());
		});
		
		function updateLineNum(){
			// landscape 为true 代表横向
			if($("#excelVersion").val() == "wps"){
				$("#pageSize").val("51");//wps纵向50行
			}else if($("#excelVersion").val() == "excel"){
				$("#pageSize").val("58");//excel纵向57行
			}
		}
		
		
		function validForm(){
			if($("#examType").val() == ""){
	 			layer.msg('请先选择考试类型');
	 			return false;
			}
			if($("#excelVersion").val() == ""){
	 			layer.msg('请先选择excel版本');
	 			return false;
			}
			if($("#pageSize").val() == ""){
	 			layer.msg('请先填写“每页的行数”');
	 			return false;
			}
			return true;
		}
		
		
		function submit(excelFile){
			var formData = new FormData();
			formData.append("uploadFile",excelFile);
			formData.append("pageSize",$.trim($("#pageSize").val()));
			formData.append("examType",$.trim($("#examType").val()));
			formData.append("encodeType",$.trim($("#encodeType").val()));
			
			loadingLayer = layer.msg('正在加载...', {icon: 16, time:0, shade: [0.1,'#fff']});
			$.ajax({  
		         url: applicationPath + "/excel/handleExcel4",  
		         type: 'POST',  
		         data: formData,  async: true,   cache: false,   contentType: false,  dataType: 'json',
		         processData: false,  
		         success: function (data) {
		 			layer.close(loadingLayer);
		 			layer.msg('处理完成');
		 			if(data.rtResponse != null && data.rtResponse.rt_code == 200){
		 				
		 				var log = data.rtResponse.rtResult.log;
		 				console.info(log.length);
		 				for(var i=0;i<log.length;i++){
		 					$("#logDisplay").append("<p>"+ log[i] +"</p>");
		 				}

		 				$("#logDisplay p:last")[0].scrollIntoView(true);
		 				$("h2")[0].scrollIntoView(true);
		 				
		 				var fileName = data.rtResponse.rtResult.name;
		 				location.href = applicationPath + "/excel/downloadExcel?fileName=" + fileName;
		 			}else if(data.rtResponse != null && data.rtResponse.rt_code == 403){
		 				layer.msg("会话超时，请刷新页面后重试");
					}else{
						layer.msg("请求失败，请联系管理员");
					}
		         },  
		         error: function (data) {  
		        	 layer.msg("文件导入失败");  
		             console.info(data);
		         }  
		    });
		}
		
		function validFileAndSubmit(excelFile){
			
			var fileName = excelFile.name;//获取文件名称
			if(validFileType(fileName) && validForm()){
				//validate form
				submit(excelFile);
			}
			
		}
		
		
		var uploadElementId = initUploadElement("#uploadDiv");//自定义的上传组件By xiaojz
		$("#" + uploadElementId).change(function(){
			if($("#" + uploadElementId)[0].value == "" ){
				return;
			}
		   validFileAndSubmit($("#" + uploadElementId)[0].files[0]);
		   $("#" + uploadElementId).val("");//清空上传框
		});
		
		$("#uploadDiv")[0].addEventListener("drop",function(e){
			var fileList = e.dataTransfer.files;
			if(fileList.length = 0){
				return false;
			}
			validFileAndSubmit(fileList[0]);
		});
		
		
		function validFileType(fileName){
		   var suffixIndex=fileName.lastIndexOf(".");  
		   var suffix=fileName.substring(suffixIndex+1).toUpperCase();  
		   if(suffix!="dbf" && suffix!="DBF"){  
				layer.msg('请上传excel表格文件');
				return false;
		   }else{
			   return true;
		   }
		}
		
		
	
	</script>
</body>
</html>